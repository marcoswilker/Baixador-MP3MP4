import streamlit as st
import yt_dlp
import os
import tempfile

# 1. Configura√ß√£o da P√°gina
st.set_page_config(page_title="Download Pro", page_icon="‚ö°", layout="centered")

# Estilo visual para o bot√£o (CSS)
st.markdown("""
    <style>
    div.stButton > button:first-child {
        background-color: #FF0000;
        color: white;
        border-radius: 10px;
        width: 100%;
        font-weight: bold;
    }
    </style>
""", unsafe_allow_html=True)

st.title("‚ö° YouTube Downloader Pro")

# --- FORMUL√ÅRIO DE INTERFACE ---
with st.form("baixador"):
    video_url = st.text_input("üîó Link do YouTube:", placeholder="Cole o link aqui...")
    
    col1, col2 = st.columns(2)
    with col1:
        formato = st.selectbox("üíø Formato:", ["MP4 (V√≠deo)", "MP3 (√Åudio)"])
    with col2:
        qualidade = st.select_slider("üåü Qualidade:", options=["Baixa", "M√©dia", "Alta"])
    
    submit = st.form_submit_button("üöÄ INICIAR EXTRA√á√ÉO")

# --- L√ìGICA DE DOWNLOAD ---
def baixar_midia(url, formato_escolhido, qualidade_escolhida):
    temp_dir = tempfile.gettempdir()
    
    # Mapeamento de qualidade para o yt-dlp
    qualidade_map = {
        "Baixa": "worst",
        "M√©dia": "intermediate",
        "Alta": "best"
    }
    q = qualidade_map[qualidade_escolhida]

    # Cabe√ßalhos para evitar o Erro 403 (Forbidden)
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache',
    }

    common_opts = {
        'outtmpl': f'{temp_dir}/%(title)s.%(ext)s',
        'restrictfilenames': True,
        'noplaylist': True,
        'http_headers': headers,
        'compat_opts': ['force-ipv4'],
        'extractor_args': {'youtube': {'player_client': ['web', 'android']}},
    }

    if "MP4" in formato_escolhido:
        ydl_opts = {
            **common_opts,
            'format': f'{q}video+bestaudio/best',
            'merge_output_format': 'mp4',
        }
    else:
        ydl_opts = {
            **common_opts,
            'format': 'bestaudio/best',
            'postprocessors': [{
                'key': 'FFmpegExtractAudio',
                'preferredcodec': 'mp3',
                'preferredquality': '192',
            }],
        }

    with yt_dlp.YoutubeDL(ydl_opts) as ydl:
        info = ydl.extract_info(url, download=True)
        filename = ydl.prepare_filename(info)
        if "MP3" in formato_escolhido:
            filename = os.path.splitext(filename)[0] + ".mp3"
        return filename

# --- A√á√ÉO AO CLICAR ---
if submit:
    if not video_url:
        st.warning("‚ö†Ô∏è Por favor, cole um link v√°lido do YouTube.")
    else:
        try:
            with st.spinner("‚è≥ Processando... Isso pode levar alguns segundos."):
                caminho_arquivo = baixar_midia(video_url, formato, qualidade)
                
                with open(caminho_arquivo, "rb") as f:
                    st.success("‚úÖ Extra√ß√£o conclu√≠da com sucesso!")
                    st.download_button(
                        label="üì• Baixar para o meu dispositivo",
                        data=f,
                        file_name=os.path.basename(caminho_arquivo),
                        mime="video/mp4" if "MP4" in formato else "audio/mpeg"
                    )
        except Exception as e:
            st.error(f"‚ùå Erro ao processar: {e}")

st.info("Nota: O processamento ocorre no servidor e o download final √© feito no seu navegador.")
